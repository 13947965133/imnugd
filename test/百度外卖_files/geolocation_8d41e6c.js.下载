clouda.define("device/geolocation",function(o){function c(o,c,e){return t([o/Math.pow(2,e-18),c/Math.pow(2,e-18)])}function t(o){var c,t;c=[Math.abs(o[0]),Math.abs(o[1])];for(var n=0;n<g.length;n++)if(c[1]>=g[n]){t=E[n];break}var a=e(o,t),o=[a[0].toFixed(6),a[1].toFixed(6)];return o}function e(o,c){if(o&&c){var t=c[0]+c[1]*Math.abs(o[0]),e=Math.abs(o[1])/c[9],n=c[2]+c[3]*e+c[4]*e*e+c[5]*e*e*e+c[6]*e*e*e*e+c[7]*e*e*e*e*e+c[8]*e*e*e*e*e*e;return t*=o[0]<0?-1:1,n*=o[1]<0?-1:1,[t,n]}}function n(o,c){window.geo_map_callback=function(t){var e={};for(elem in o.coords)e[elem]=o.coords[elem];t.status?e.coordtype=clouda.device.COORDTYPE.GPS:(e.coordtype=clouda.device.COORDTYPE.BD,e.longitude=t.result[0].x,e.latitude=t.result[0].y),c(e)};var t=window.location.protocol+"//api.map.baidu.com/geoconv/v1/?coords="+o.coords.longitude+","+o.coords.latitude+"&ak=dxNDR8hM1qmok1yIimchoRDA&callback=geo_map_callback";T(t,function(o){document.head.removeChild(o)})}var a=clouda.lightapp,i=clouda.device.geolocation={},o=clouda.device||{},u=clouda.DelegateClass,l=(clouda.kuangForReady,clouda.runtimeError,clouda.installPlugin,clouda.cloudaBLight),r=clouda.ErrCode;o.LOCATION_METHOD={BASE_STATION:0,GPS:1},o.LOCERR={PERMISSION_DENIED:1,POSITION_UNAVAILABLE:2,TIMEOUT:3},o.COORDTYPE={BD:"bd09ll",GCJ:"gcj02ll",GPS:"wgs84ll"};var d=new u("map","start"),s=new u("map","stop"),f=clouda.lib.utils.stat,T=(clouda.lib.utils,function(o,c){var t=document.createElement("script");t.setAttribute("src",o),document.head.appendChild(t),t.onload=function(){c&&c(t)}}),g=[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],E=[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]];i.get=function(o){if(clouda.BOX_VERSION){for(var t,e,i=document.cookie.split(";"),u=i.length-1;u>=0;u--)if(e=i[u].trim().split("="),"BAIDULOC"==e[0]){t={},t.x=e[1].split("_")[0],t.y=e[1].split("_")[1];break}if(t&&!isNaN(t.x)&&!isNaN(t.y)){var T=c(t.x,t.y,18),g={};return g.coords={},g.coords.coordtype=clouda.device.COORDTYPE.BD,g.coords.longitude=T[0],g.coords.latitude=T[1],void o.onsuccess(g.coords)}}if(clouda.RUNTIME===clouda.RUNTIMES.KUANG&&BLightApp&&"function"==typeof BLightApp.getCurrentPosition)return f({api:"geolocation.get",runtime:"kuang"}),clouda.PLATFORM===clouda.PLATFORMS.IOS?void l("getCurrentPosition",JSON.stringify({}),function(c){n(c,o.onsuccess)},o.onfail):(l("getCurrentPosition",function(c){c.coords.coordtype=clouda.device.COORDTYPE.BD,o.onsuccess(c.coords)},o.onfail),!1);if(clouda.RUNTIME===clouda.RUNTIMES.NUWA&&clouda.PLATFORM===clouda.PLATFORMS.ANDROID)f({api:"geolocation.get",runtime:"nuwa"}),d(function(c){"object"==typeof c?(c.coordtype=clouda.device.COORDTYPE.GCJ,o.onsuccess(c)):a.error(r.LOC_GET_ERR,r.UNKNOW_CALLBACK,o),s(function(){},function(){})},function(c){a.error(r.LOC_GET_ERR,c,o)},o);else{if(clouda.RUNTIME===clouda.RUNTIMES.LIGHTSDK){var E=function(c){"undefined"!=typeof c.coordtype&&(c.coordtype=clouda.device.COORDTYPE.BD),o.onsuccess(c)},p=function(c){"undefined"!=typeof c.coordtype&&(c.coordtype=clouda.device.COORDTYPE.BD),o.onfail(c)};return f({api:"geolocation.get",runtime:"o2o"}),void clouda.lightsdk(E,p,"device.map","get",{})}f({api:"geolocation.get",runtime:"web"});try{navigator.geolocation2.getCurrentPosition(function(c){n(c,o.onsuccess)},o.onfail)}catch(R){o.onfail(clouda.STATUS.SYSTEM_FAILURE)}}};var p=0;return i.startListen=function(o){if(f({api:"geolocation.startListen"}),clouda.RUNTIME===clouda.RUNTIMES.KUANG)return l("startListenLocation",function(c){o.onsuccess(c.coords)},o.onfail),!1;if(clouda.RUNTIME===clouda.RUNTIMES.NUWA)d(function(c){"object"==typeof c?o.onsuccess(c):a.error(r.LOC_GET_ERR,r.UNKNOW_CALLBACK,o)},function(c){a.error(r.LOC_GET_ERR,c,o)},o);else{if(clouda.RUNTIME===clouda.RUNTIMES.LIGHTSDK){var c=function(c){delete c.loctype,c.coordtype=clouda.device.COORDTYPE.BD,o.onsuccess(c)},t=function(c){delete c.loctype,o.onfail(c)};return clouda.lightsdk(c,t,"device.map","start",{}),!1}try{navigator.geolocation2.clearWatch(p),p=navigator.geolocation2.watchPosition(function(c){o.onsuccess(c.coords)},o.onfail)}catch(e){o.onfail(clouda.STATUS.SYSTEM_FAILURE)}}},i.stopListen=function(o){if(f({api:"geolocation.stopListen"}),clouda.RUNTIME===clouda.RUNTIMES.KUANG)return void l("stopListenLocation",function(){o.onsuccess(clouda.STATUS.SUCCESS)},o.onfail);if(clouda.RUNTIME===clouda.RUNTIMES.NUWA)s(function(){o.onsuccess(clouda.STATUS.SUCCESS)},function(c){a.error(r.LOC_GET_ERR,c,o)},o);else{if(clouda.RUNTIME===clouda.RUNTIMES.LIGHTSDK){var c=function(c){c=1,o.onsuccess(c)},t=function(c){delete c.error_code,o.onfail(c)};return void clouda.lightsdk(c,t,"device.map","stop",{})}try{navigator.geolocation2.clearWatch(p),o.onsuccess(clouda.STATUS.SUCCESS)}catch(e){o.onfail(clouda.STATUS.SYSTEM_FAILURE)}}},navigator.geolocation2=navigator.geolocation,clouda.RUNTIME>0&&clouda.PLATFORM===clouda.PLATFORMS.ANDROID&&(navigator.geolocation.getCurrentPosition=function(o,c,t){t=t||{},t.onsuccess=function(c){o({coords:c,timestamp:0})},t.onfail=function(o){c&&c(o)},i.get(t)},navigator.geolocation.watchPosition=function(o,c,t){t=t||{},t.onsuccess=function(c){o({coords:c,timestamp:0})},t.onfail=function(o){c&&c(o)},i.startListen(t)},navigator.geolocation.clearWatch=function(){var o={};o.onsuccess=function(){},o.onfail=function(){},i.stopListen(o)}),o});